<!doctype HTML>
<html>

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136675623-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-136675623-1');
    </script> -->
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
<script src="scripts/gif.js"> </script>
<!-- <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script> -->
<!-- <script src="https://rawgit.com/mayognaise/aframe-gif-component/master/dist/aframe-gif-component.min.js"></script>  -->
<script src="https://rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
  var isTargetFound = false;
  var interacted = false;
  var cuenta2 = 0;
  AFRAME.registerComponent("markerhandler", {
    init: function () {
      console.log('markerhandler-init');

      markerObj = document.querySelector('a-marker');
      markerObj.hidden = true;

      //dino.setAttribute('animation-mixer', {clip: 'C4D Animation Take', loop: 'repeat'});
    },

    tick: function () {

      if (markerObj != null) {
        if (markerObj.object3D.visible == true) {

          if (isTargetFound)
            return;

          isTargetFound = true;
          console.log("marker visible");
          cuenta2++;
          if (cuenta2 == 1) {
            document.getElementById("qr").emit("qrout");
            document.getElementById("plane").emit("planeout");
            /* document.getElementById("swipe").emit("planein"); */
          }

          //document.getElementById("videoScene").emit("an1");
        }
        else {

          if (!isTargetFound)
            return;

          isTargetFound = false;
          console.log("marker invisible");

        }
      }
    }
  });
</script>

<body style='margin : 0px; overflow: hidden;' id="cuerpo" onload="imgLoaded()">
  <!-- we add detectionMode and matrixCodeType to tell AR.js to recognize barcode markers -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; patternRatio: 0.8;">
    <a-assets>
      <img id="reyna" src="images/reyna4-320.gif">


      <img id="clock" src="images/clock.gif">
      <!-- <video id="video" autoplay loop="true" src="images/diamonds.mp4"></video> -->
      <!-- <video id="video" width="320" height="180" controls>
                  <source src="images/video.mp4" type="video/mp4">
              </video> -->
    </a-assets>
    <!--<a-entity light="type: ambient; color: #FFF"></a-entity>
            <a-entity id="luz1" light="type: directional; color: #FFF; intensity: .6" position="1 0 1"></a-entity>
            <a-entity id="luz2" light="type: directional; color: #FFF; intensity: .6" position="-1 -.5 1"></a-entity>-->

    <a-marker markerhandler emitevents="true" cursor="fuse: false; rayOrigin: mouse" type="pattern"
      url="pattern-reyna.patt">

      <!-- <a-box></a-box> -->
      <!-- <a-plane rotation="-90 0 0" oapcity=".9" width="2" height="2" material="shader: gif" src="#clock" ></a-plane> -->
      <a-plane id="gif" rotation="-90 0 0" opacity=".9" width="2" height="2" material="shader: gif;" gif="" src="#reyna"
        position="0 0 0" animation="startEvents: gifIn; property: opacity; dur: 2000; to: .7;" ;></a-plane>
      <!-- <a-plane id="gif" rotation="-90 0 0" opacity=".2" width="2" height="2" position="0 0 0"
            animation="startEvents: gifIn; property: opacity; dur: 2000; to: .9;"
            ></a-plane> -->

    </a-marker>
    <!-- <a-plane id="powered" position="-.001 -.03 -.1" width=".02" height=".006" opacity=".3" material="src: images/powvector.png"></a-plane> -->

    <!-- <a-plane id="plano" position="0 0 -.12" width="40" height="40" opacity="0"></a-plane> -->
    <a-plane id="plane" position="0 0 -.098" width="2" height="2" material="color:black;" opacity=".4"
      animation="startEvents: planeout; property: opacity; dur: 1000; to: 0;">
      <!--  <a-animation
                attribute="opacity"
                begin="planeout"
                dur="1000"
                to="0"
            ></a-animation> -->
    </a-plane>
    <a-plane id="qr" position="0 0 -.097" width=".02" height=".02" material="src:images/enfoca.png;" opacity=".9"
      animation="startEvents: qrout; property: opacity; dur: 1000; to: 0;">
      <!-- <a-animation
                attribute="opacity"
                begin="qrout"
                dur="1000"
                to="0"
            ></a-animation> -->
    </a-plane>
    <a-entity camera></a-entity>
  </a-scene>
</body>

<script>
  /* document.getElementById('gif').pause();
  
  window.setTimeout((nada) => {
    console.log('se ejecuta gif play');
    document.getElementById('gif').play();
  }, 25000);   */
  let status = 0;
  let gifG = null;
  document.getElementById('cuerpo').addEventListener('click', function () {

    if (status) {
      gifG.pause();
      console.log('pause');
    } else {
      gifG.components.material.shader.nextFrame();
      console.log('frame: ', gifG.components.material.shader);
    }
    status = !status;



  });
  var intervalID;
  function imgLoaded() {
    /* alert('imagen cargada'); */
    gifG = document.getElementById('gif');

    gifG.pause();
    console.log('pause');
    console.log('initframe: ', gifG.components.material.shader);

    window.setTimeout(function () {
      gifG.components.material.shader.__startTime = Date.now();
      intervalID = window.setInterval(miFuncion, 100);

      /* for (var i = 0; i < 20; i++) {
        gifG.components.material.shader.nextFrame();
        console.log('frameIdx: ', gifG.components.material.shader);
      } */
    }, 7000);
    var idx = 0;
    var direccion = true;
    var loop = 0;
    function miFuncion() {
      /* gifG.components.material.shader.nextFrame();
      var frameIndex = gifG.components.material.shader.__frameIdx;
      var frameCnt = gifG.components.material.shader.__frameCnt; */
      //console.log('frameIdx: ', frameIndex, "  frameCnt: ",frameCnt);
      
      gifG.components.material.shader.nextFrame(idx);
      //console.log('index: ',idx)
      if(direccion){
        idx++;
      }else{
        idx--;
      }
      //idx ++;
      if((idx > 60) && (direccion)){
        //idx = 35;
        direccion = false;
        idx = 60;
        loop++;
        console.log('loop: ',loop)
      }
      if((idx < 42) && (!direccion) && (loop < 3)){
        //idx = 35;
        direccion = true;
        idx = 42;
      }else if(idx < 0){
        clearInterval(intervalID);
      }

    }


  }
/* window.setTimeout(function(){
    document.getElementById('gif').play();
      document.getElementById('gif').emit("gifIn");
      console.log('emit animacion');
    }, 8000); */

</script>

</html>