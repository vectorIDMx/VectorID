<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-136675623-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-136675623-1');
    </script> -->
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
<script src="scripts/gif.js"> </script>
<!-- <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script> -->
<!-- <script src="https://rawgit.com/mayognaise/aframe-gif-component/master/dist/aframe-gif-component.min.js"></script>  -->
<script src="https://rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
  var isTargetFound = false;
  var interacted = false;
  var cuenta2 = 0;
  AFRAME.registerComponent("markerhandler", {
    init: function () {

      markerObj = document.querySelector('a-marker');
      markerObj.hidden = true;

      //dino.setAttribute('animation-mixer', {clip: 'C4D Animation Take', loop: 'repeat'});
    },

    tick: function () {

      if (markerObj != null) {
        if (markerObj.object3D.visible == true) {

          if (isTargetFound)
            return;

          isTargetFound = true;
          //console.log("marker visible");

          cuenta2++;
          if (cuenta2 == 1) {
            document.getElementById("plane").emit("planeout");
            document.getElementById("qr").emit("qrout");

            document.getElementById("logo").emit("inLogo");
            document.getElementById("planeLogo").emit("subelogo");
            //audFondo.play();
            //gif.play();
            /* document.getElementById("swipe").emit("planein"); */
          }

          //document.getElementById("videoScene").emit("an1");
        }
        else {

          if (!isTargetFound)
            return;

          isTargetFound = false;
          //console.log("marker invisible");

        }
      }
    }
  });
</script>

<body style='margin : 0px; overflow: hidden;' id="cuerpo" onload="imgLoaded()">
  <audio id="audio" src="audio/tambores.mp3" autoplay loop muted></audio>
  <!-- we add detectionMode and matrixCodeType to tell AR.js to recognize barcode markers -->
  <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false; patternRatio: 0.8;">
    <a-assets>
      <img id="reyna" src="images/reyna4-320.gif">
    </a-assets>

    <a-marker markerhandler emitevents="true" cursor="fuse: false; rayOrigin: mouse" type="pattern"
      url="pattern-reyna.patt">

      <a-plane id="gif" rotation="-90 0 0" opacity="0" width="2" height="2" material="shader: gif;" gif="" src="#reyna"
        position="0 0 0" animation="startEvents: gifin; property: opacity; dur: 2000; to: .9;"></a-plane>

      <a-entity id="logo" scale=".001 .001 .001"
        animation=" startEvents: inLogo; property: rotation; dur: 1000; from: 0 0 0; to: 0 360 0; loop: 5; easing: linear;"
        animation__2=" startEvents: inLogo; property: scale; dur: 5000; from: .001 .001 .001; to: 1 1 1; easing: linear;">
        <a-plane id="planeLogo" position="0 0.1 -.5" rotation="-90 0 0" opacity=".9" width="1.5" height=".5"
          material="src: images/logo.png"
          animation="startEvents: subelogo; property: position; dur: 4000; to: 0 0.1 -1.3;"></a-plane>
      </a-entity>
      <a-plane id="fondo" position="0 .1 0" rotation="-90 0 0" material="src: images/fondo.png" opacity=".99"
        animation="property: rotation; dur: 2000; to: -90 360 0; easing: linear; loop: true;"
        animation__2="startEvents:fondoout; property: scale; dur: 1500; to: .0001 .0001 .0001; easing: linear;">
      </a-plane>
      <!-- <a-box position="0 -.11 0" opacity=".99" scale="1.4 .2 3" material="src: images/nada.png; color: yellow;"></a-box>
      <a-cylinder rotation="-90 0 0" scale="2 .2 2"></a-cylinder> -->

    </a-marker>


    <a-plane id="plane" position="0 0 -.098" width="2" height="2" material="color:black;" opacity=".4"
      animation="startEvents: planeout; property: opacity; dur: 1000; to: 0;">

    </a-plane>
    <a-plane id="qr" position="0 0 -.097" width=".02" height=".02" material="src:images/enfoca.png;" opacity=".9"
      animation="startEvents: qrout; property: opacity; dur: 1000; to: 0;">

    </a-plane>
    <a-entity camera></a-entity>
  </a-scene>
</body>

<script>
  let status = 0;
  let gifG;
  var intervalID;
  var paramstr = window.location.search.substr(1);
  var paramarr = paramstr.split("&");
  var params = {};
  var language;
  /* var audFondo = new Audio();
  audFondo.src = "audio/tambores.ogg"; */
  var aud1 = new Audio();
  aud1.src = "audio/espanol.mpeg";
  var aud2 = new Audio();
  aud2.src = "audio/ingles.mp3";

  for (var i = 0; i < paramarr.length; i++) {
    var tmparr = paramarr[i].split("=");
    params[tmparr[0]] = tmparr[1];
  }
  language = params['lang'];
  if (language) {
    //console.log('El valor del parámetro variable es: ' + language);
  } else {
    //console.log('No se envió el parámetro variable');
  }
  function imgLoaded() {

    gifG = document.getElementById('gif');
    gifG.pause();
    audioFondo = document.getElementById('audio');
    console.log('audioFondo: ', audioFondo);
    audioFondo.volume = 1;
    audioFondo.muted = false;
    console.log('audioFondo: ', audioFondo);



    var idx = 0;
    var direccion = true;
    var loop = 0;
    function miFuncion() {

      gifG.components.material.shader.nextFrame(idx);
      idx++;

      if (idx > 60) {
        idx = 0;
      }

      /* if (direccion) {
        idx++;
      } else {
        idx--;
      }

      if ((idx > 60) && (direccion)) {

        direccion = false;
        idx = 60;
        loop++;

      }
      if ((idx < 42) && (!direccion) && (loop < 2)) {

        direccion = true;
        idx = 42;
      } else if (idx < 0) {
        clearInterval(intervalID);
      } */
    }
    document.getElementById('planeLogo').addEventListener('animationcomplete', function () {
      document.getElementById('gif').emit('gifIn');


    });
    document.getElementById('logo').addEventListener('animationcomplete__2', function () {
      document.getElementById('fondo').emit('fondoout');

      window.setTimeout(function () {
        gifG.components.material.shader.nextFrame(0);
        gif.play();
        document.getElementById('gif').emit('gifin');
      }, 1000);
      window.setTimeout(function () {
        //gifG.components.material.shader.__startTime = Date.now();
        intervalID = window.setInterval(miFuncion, 150);
        window.setTimeout(function () {
          //gifG.components.material.shader.__startTime = Date.now();
          if (language == 'es') {
            aud1.play();
          } else {
            aud2.play();
          }

        }, 3500);
      }, 3500);

    });
  }

</script>

</html>